<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mega Puzzle Game üß©</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #fbc2eb, #a6c1ee);
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    h1 {
      color: #ff4081;
      font-size: 2em;
    }
    #preview {
      width: 150px;
      height: 150px;
      border: 2px solid white;
      box-shadow: 0 0 10px #999;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 5px;
    }
    #puzzle-container {
      width: 560px;
      height: 720px;
      margin: 30px auto;
      display: flex;
      flex-wrap: wrap;
      border: 3px solid #fff;
      box-shadow: 0 0 20px #ccc;
      position: relative;
    }
    .tile {
      width: 70px;
      height: 90px;
      box-sizing: border-box;
      border: 0.5px solid #fff;
      background-size: 560px 720px;
      cursor: grab;
    }
    #message, #timer {
      text-align: center;
      font-size: 1.2em;
      color: #333;
      margin-top: 10px;
    }
    #controls {
      text-align: center;
    }
    button {
      font-size: 1em;
      padding: 10px 20px;
      background-color: #ff6f91;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ff4e75;
    }
    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1000;
      font-size: 5em;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    canvas#fireworkCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 999;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>üß† Mega Puzzle Game (8x8)</h1>
    <div id="preview"></div>
  </header>
  <div id="timer">‚è±Ô∏è Time: 0s</div>
  <div id="puzzle-container"></div>
  <div id="controls"><button onclick="createPuzzle()">üîÅ Restart Puzzle</button></div>
  <div id="message"></div>
  <div id="celebration" class="celebration" style="display: none;">üéÜüíñüéá</div>
  <canvas id="fireworkCanvas"></canvas>

  <script>
    const puzzle = document.getElementById("puzzle-container");
    const message = document.getElementById("message");
    const preview = document.getElementById("preview");
    const timerEl = document.getElementById("timer");
    const celebration = document.getElementById("celebration");

    const imageSrc = "aak4.jpg";
    preview.style.backgroundImage = `url(${imageSrc})`;

    let tiles = [];
    const gridSize = 8;
    const containerW = 560;
    const containerH = 720;
    const tileW = containerW / gridSize;
    const tileH = containerH / gridSize;

    let timer = 0;
    let interval;

    function createPuzzle() {
      puzzle.innerHTML = "";
      message.textContent = "";
      tiles = [];
      clearInterval(interval);
      timer = 0;
      timerEl.textContent = "‚è±Ô∏è Time: 0s";
      celebration.style.display = "none";
      preview.style.display = "block";

      for (let i = 0; i < gridSize * gridSize; i++) {
        const tile = document.createElement("div");
        tile.classList.add("tile");
        tile.setAttribute("data-correct", i);
        tiles.push(tile);
      }

      shuffleArray(tiles);

      tiles.forEach((tile, index) => {
        tile.setAttribute("data-current", index);
        const pos = tile.getAttribute("data-correct");
        const x = (pos % gridSize) * -tileW;
        const y = Math.floor(pos / gridSize) * -tileH;
        tile.style.width = `${tileW}px`;
        tile.style.height = `${tileH}px`;
        tile.style.backgroundImage = `url(${imageSrc})`;
        tile.style.backgroundSize = `${containerW}px ${containerH}px`;
        tile.style.backgroundPosition = `${x}px ${y}px`;
        puzzle.appendChild(tile);
      });

      enableDragAndDrop();
      updateCorrectCount();
      startTimer();
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function addDragEvents(tile) {
      tile.draggable = true;

      tile.addEventListener("dragstart", e => {
        const allTiles = [...document.querySelectorAll(".tile")];
        e.dataTransfer.setData("text/plain", allTiles.indexOf(tile));
      });

      tile.addEventListener("dragover", e => e.preventDefault());

      tile.addEventListener("drop", e => {
        e.preventDefault();
        const allTiles = [...document.querySelectorAll(".tile")];
        const fromIndex = e.dataTransfer.getData("text/plain");
        const toIndex = allTiles.indexOf(tile);
        if (fromIndex !== toIndex) swapTiles(fromIndex, toIndex);
      });
    }

    function enableDragAndDrop() {
      const tiles = document.querySelectorAll(".tile");
      tiles.forEach(addDragEvents);
    }

    function swapTiles(fromIndex, toIndex) {
      const tileList = [...document.querySelectorAll(".tile")];
      const fromTile = tileList[fromIndex];
      const toTile = tileList[toIndex];

      const fromClone = fromTile.cloneNode(true);
      const toClone = toTile.cloneNode(true);

      addDragEvents(fromClone);
      addDragEvents(toClone);

      puzzle.replaceChild(fromClone, toTile);
      puzzle.replaceChild(toClone, fromTile);

      updateCorrectCount();
      checkWin();
    }

    function updateCorrectCount() {
      const currentTiles = document.querySelectorAll(".tile");
      let correctCount = 0;
      for (let i = 0; i < currentTiles.length; i++) {
        if (currentTiles[i].getAttribute("data-correct") == i) correctCount++;
      }
      message.textContent = `‚úîÔ∏è ${correctCount} / 64 tiles correct`;
    }

    function checkWin() {
      const currentTiles = document.querySelectorAll(".tile");
      for (let i = 0; i < currentTiles.length; i++) {
        if (currentTiles[i].getAttribute("data-correct") != i) return;
      }
      clearInterval(interval);
      message.textContent = "üéâ Wow, very good!";
      puzzle.innerHTML = "";
      preview.style.display = "none";
      celebration.style.display = "flex";
      launchFireworks(7);
    }

    function startTimer() {
      interval = setInterval(() => {
        timer++;
        timerEl.textContent = `‚è±Ô∏è Time: ${timer}s`;
      }, 1000);
    }

    // üéÜ Fireworks
    const canvas = document.getElementById("fireworkCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let fireworks = [];

    function random(min, max) {
      return Math.random() * (max - min) + min;
    }

    class Firework {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = random(canvas.width * 0.2, canvas.width * 0.8);
        this.y = canvas.height;
        this.targetY = random(canvas.height * 0.2, canvas.height * 0.5);
        this.speed = random(4, 7);
        this.exploded = false;
        this.particles = [];
      }
      update() {
        if (!this.exploded) {
          this.y -= this.speed;
          if (this.y <= this.targetY) {
            this.exploded = true;
            for (let i = 0; i < 50; i++) {
              this.particles.push(new Particle(this.x, this.y));
            }
          }
        } else {
          this.particles.forEach(p => p.update());
          this.particles = this.particles.filter(p => p.alpha > 0);
        }
      }
      draw() {
        if (!this.exploded) {
          ctx.beginPath();
          ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
          ctx.fillStyle = "white";
          ctx.fill();
        } else {
          this.particles.forEach(p => p.draw());
        }
      }
    }

    class Particle {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.angle = random(0, 2 * Math.PI);
        this.speed = random(1, 5);
        this.vx = Math.cos(this.angle) * this.speed;
        this.vy = Math.sin(this.angle) * this.speed;
        this.alpha = 1;
        this.gravity = 0.05;
        this.color = `hsl(${Math.floor(random(0, 360))}, 100%, 60%)`;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += this.gravity;
        this.alpha -= 0.02;
      }
      draw() {
        ctx.globalAlpha = this.alpha;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.globalAlpha = 1;
      }
    }

    function animateFireworks() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      fireworks.forEach(f => {
        f.update();
        f.draw();
      });
      fireworks = fireworks.filter(f => f.particles.length > 0 || !f.exploded);
      requestAnimationFrame(animateFireworks);
    }

    function launchFireworks(count = 5) {
      for (let i = 0; i < count; i++) {
        fireworks.push(new Firework());
      }
      animateFireworks();
    }

    createPuzzle();
  </script>
</body>
</html>
